{% extends "site_base.html" %}
{% load i18n %}
{% load comments %}
{% load annotatetags %}
{% load hashtag %}
{% block extratitle %}{{ title }}{% endblock %}
{% block keywords %}{{ title }}{% endblock %}
{% block description %}{{ title }} - {% endblock %}
{% block extrahead %}
    <link href="{{MEDIA_URL}}annotatetext/annotate.css" rel="stylesheet" type="text/css" media="screen" />
    <script type="text/javascript" src="{{MEDIA_URL}}annotatetext/annotate.js"></script>
    <script type="text/javascript" src="{{MEDIA_URL}}js/jquery.colorPicker.js"></script>
{% endblock %}
{% block nav-committees %}class="selected"{% endblock %}
{% block divcontent %}
    <h2>{{ title }}</h2>
    <a href="{% url committee-detail object.committee.id %}">{% trans 'Back to committee' %}</a><br>
    <h3>{% trans 'Topics' %}</h3> {{ object.topics|safe }}<br>
    <h3>{% trans 'MKs attended' %}</h3> {% for m in object.mks_attended.all %}<a class="hashnav item dontwrap" id="member-{{ m.id }}" href="{% url member-detail m.id %}" title="{{ m.current_party.name }}">{{ m.name }}</a> &nbsp; {% endfor %}<br>
    {% if user.is_authenticated %}
        {% trans 'Suggest an MK' %}<form method="post" action=".">{% csrf_token %}<input type="hidden" name="user_input_type" value="mk"></input><input type="text" name="mk_name"></input><input type="submit" value="{% trans 'Submit' %}"></input></form>
    {% endif %}                
    
    <h3>{% trans 'Bills' %}</h3> {% for b in object.bills_first.all %}<a class="hashnav item dontwrap" href="{% url bill-detail b.id %}" />{{ b }}</a> &nbsp; {% endfor %}
                                 {% for b in object.bills_second.all %}<a class="hashnav item dontwrap" href="{% url bill-detail b.id %}" />{{ b }}</a> &nbsp; {% endfor %}                                 
    <br>
    {% if user.is_authenticated %}
        {% trans 'Suggest a matching bill' %}<form method="post" action=".">{% csrf_token %}<input type="hidden" name="user_input_type" value="bill"></input><input type="text" name="bill_id"></input><input type="submit" value="{% trans 'Submit' %}"></input></form>
    {% endif %}                

  {% with object.parts.list as parts %}
    {% get_annotations_for parts as annotation_dict %}
    <h3>{% trans 'Protocol' %}</h3>
    <div class="protocol">
    {% for speech_part in parts %}
      {% with speech_part.id as spid %}
      {% with annotation_dict|hash:spid as annotation_obj %}
      <div class="speech-{{ object.id }} speech-container" id="speech-{{ object.id }}-{{ speech_part.order }}">
        <div class="text-speaker">
            {% firstof speech_part.header "&nbsp;" %}
        </div>
        <div class="text-content" id="annotations-{{ speech_part.id }}_content">
            <blockquote cite="{{ session.document_url }}" id="annotationtext_{{ speech_part.id }}" class="entry-content">{{ speech_part.body|simple_formatting }}</blockquote>
        </div>
        <div style="display:none" class="annotationtoolbox annotating" id="annotationtoolbox-{{ speech_part.id }}">
            <label for="markall-{{ speech_part.id }}">{% trans "View all" %}</label>
            <input type="checkbox" class="markall" name="markall-{{ speech_part.id }}" id="markall-{{ speech_part.id }}"/>
        </div>
        <p class="tool-links">
            <a href="#annotationform-{{ speech_part.id }}" class="annotationform-link annotating" id="selectable-{{ speech_part.id }}">{% trans "Annotate"%}</a>
            {% ifnotequal speech_part.order 1 %}
                <a href="#speech-{{ object.id }}-{{ speech_part.order }}" rel="bookmark" class="permalink">{% trans "Permalink" %}</a>
            {% endifnotequal %}
        </p>
        <div class="annotating annotation-content" id="annotations-{{ speech_part.id }}">
            {% with annotation_obj.annotations as annotations %}
            {% for annotation in annotations %}
            {% include "annotatetext/_annotation.html" %}
            {% endfor %}
            {% endwith %}
        </div>
        <div style="display:none" class="annotation-form" id="annotationform-{{ speech_part.id }}">
            <form action="{% url annotatetext-post_annotation %}" method="post" accept-charset="utf-8" id="annotationrealform-{{ speech_part.id }}" class="annotationrealform">{% csrf_token %}
            {% with annotation_obj|hash:"form" as annotation_form %}
                <span class="arrowhint">&#8592;{% trans "Passage mark" %}</span>
                <p class="selectionhint" id="selectionhint-{{ speech_part.id }}">{% trans "No text selected"%} </p>
                <p><span class="hideme">
                <label for="selection_start-{{ speech_part.id }}">{% trans "Beginning with" %}</label>
                <input type="text" size="3" value="" name="selection_start" id="selection_start-{{ speech_part.id }}"/>
                <label for="selection_end-{{ speech_part.id }}">{% trans "Ending with" %}</label>
                <input type="text" size="3" value="" name="selection_end" id="selection_end-{{ speech_part.id }}"/></span>
                <label>{% trans "Type your note" %}:</label>
                    {{ annotation_form.flags }}
                </p>
                {{ annotation_form.comment }}
                <div>
                    <input type="text" size="6" name="color" id="annotationcolor-{{ speech_part.id }}" value="#99ccff"/>{{ annotation_form.object_id }}{{ annotation_form.content_type }}
                    <input type="hidden" name="lengthcheck" value="{{ speech_part.body|length }}"/>
                    <input type="hidden" name="next" value="{{ next }}"/>
                    <input type="submit" value="{% trans "Save note" %}"/>
                </div>
                <p><small>
                    {% trans "Your note will be published under"%}&nbsp; <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/de/">cc-by-sa-3.0/de</a></small></p>
            {% endwith %}
            </form>
        </div>
      {% endwith %}
      {% endwith %}
        </div>
    {% endfor %}
    </div>
  {% endwith %}
{% endblock %}

{% block footer %}
    <script type="text/javascript" charset="utf-8">
    $(function(){
        $(".annotation-form").hide();
        $(".annotation-content").each(function(){
            var annoid = $(this).attr("id").split("-")[1];
            annotation_objects[annoid] = new Annotations(annoid);
        });
        for(var a in annotation_objects){
            annotation_objects[a].importQuotes();
            annotation_objects[a].insertQuotes();
        }
        $(".annotationform-link").click(function(e){
          e.preventDefault();
          var annoid = $(this).attr("id").split("-")[1];
          annotation_objects[annoid].toggleSelectView();
          if($("#annotations-"+annoid).css("display")=="none"){
            $("#annotationform-"+annoid).hide();
            $("#annotations-"+annoid).show();
            $(this).text("Annotate");
            $("#annotationrealform-"+annoid)[0].reset();
            $("#editable-"+annoid).show();
            if(annotation_objects[annoid].annotation_count >0){
              $("#annotationtoolbox-"+annoid).show();
            }
          } else{
            $(this).text("Cancel");
            $("#annotationform-"+annoid).show();
            $("#annotations-"+annoid).hide();
/*          BYOColorpicker
            if(!$("#annotationcolor-"+annoid).hasClass("colorpicking")){
              $("#annotationcolor-"+annoid).colorPicker();
            }
*/
            $("#editable-"+annoid).hide();
            $("#annotationtoolbox-"+annoid).hide();
          }
        });
      $(".markall").click(function(e){
        var aid = $(this).attr("id").split("-")[1];
        if($(this).attr('checked')){
          annotation_objects[aid].updateDefaultAnnotationColor("self");
        } else{
          annotation_objects[aid].updateDefaultAnnotationColor("inherit");
        }
      });
      $(".annotationrealform").submit(function(e){
        // e.preventDefault();
        var id = $(this).attr("id").split("-")[1];
        if($("#selection_start-"+id).val()=="" || $("#selection_end-"+id).val()==""){
            alert("Please make a selection.");
          return false;
        }
        /* var data = $(this).serializeArray();
        $.post($(this).attr("action"), data, function(data){
            var myid=id; 
            window.location.replace(data);
            });
        $("#selectable-"+id).click(); */
        return true;
      });
      $(".reallydelete").live("submit", function(e){
        return confirm('Really delete this?');
      });
      $(".annotationflagselect").change(function(e){
        var id = $(this).parents("form").attr("id").split("-")[1];
        var val = parseInt($(this).val());
        var color = null;
        switch(val){
          case 0: // Put more colors here
            color = "#99ccff"; break;
        }
        if(color != null){
          $("#color_value").val(color);
          $("#annotationcolor-"+id).val(color);
          $("div.color_picker").css("background-color", color); 
        }
      });
      $(".toggle").live("click", function(e){
         e.preventDefault();
         var id = $(this).attr("id");
         if (id == ""){
           var url = $(this).attr("href");
           var sel = $("."+url.substring(1,url.length)+"-container");
         } else {var sel = $("#"+id+"-container");}
         sel.toggle();
      });
      $('input[name=color]').colorPicker();
    });
    
    </script>
{% endblock %}
